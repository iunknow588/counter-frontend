import{d8 as E,d9 as y,da as V,db as z,dc as X,dd as Q,de as b,df as Z,dg as M,dh as _,di as ee,dj as te,dk as v,dl as L,dm as se,dn as W,dp as I,dq as j,dr as p,ds as N}from"./index-BKadGfq_.js";import{v as J,J as ne,A as x,g as ie}from"./alchemy-provider-6bbed8a2-CZ_QHJs0.js";import"@magic-sdk/provider";import"@magic-sdk/types";let T=null;try{if(T=WebSocket,T==null)throw new Error("inject please")}catch{const e=new E(J);T=function(){e.throwError("WebSockets not supported in this environment",E.errors.UNSUPPORTED_OPERATION,{operation:"new WebSocket()"})}}var H=function(a,e,t,s){function i(c){return c instanceof t?c:new t(function(l){l(c)})}return new(t||(t=Promise))(function(c,l){function r(u){try{o(s.next(u))}catch(h){l(h)}}function n(u){try{o(s.throw(u))}catch(h){l(h)}}function o(u){u.done?c(u.value):i(u.value).then(r,n)}o((s=s.apply(a,e||[])).next())})};const S=new E(J);let re=1;class oe extends ne{constructor(e,t){t==="any"&&S.throwError("WebSocketProvider does not support 'any' network yet",E.errors.UNSUPPORTED_OPERATION,{operation:"network:any"}),typeof e=="string"?super(e,t):super("_websocket",t),this._pollingInterval=-1,this._wsReady=!1,typeof e=="string"?y(this,"_websocket",new T(this.connection.url)):y(this,"_websocket",e),y(this,"_requests",{}),y(this,"_subs",{}),y(this,"_subIds",{}),y(this,"_detectNetwork",super.detectNetwork()),this.websocket.onopen=()=>{this._wsReady=!0,Object.keys(this._requests).forEach(i=>{this.websocket.send(this._requests[i].payload)})},this.websocket.onmessage=i=>{const c=i.data,l=JSON.parse(c);if(l.id!=null){const r=String(l.id),n=this._requests[r];if(delete this._requests[r],l.result!==void 0)n.callback(null,l.result),this.emit("debug",{action:"response",request:JSON.parse(n.payload),response:l.result,provider:this});else{let o=null;l.error?(o=new Error(l.error.message||"unknown error"),y(o,"code",l.error.code||null),y(o,"response",c)):o=new Error("unknown error"),n.callback(o,void 0),this.emit("debug",{action:"response",error:o,request:JSON.parse(n.payload),provider:this})}}else if(l.method==="eth_subscription"){const r=this._subs[l.params.subscription];r&&r.processFunc(l.params.result)}else console.warn("this should not happen")};const s=setInterval(()=>{this.emit("poll")},1e3);s.unref&&s.unref()}get websocket(){return this._websocket}detectNetwork(){return this._detectNetwork}get pollingInterval(){return 0}resetEventsBlock(e){S.throwError("cannot reset events block on WebSocketProvider",E.errors.UNSUPPORTED_OPERATION,{operation:"resetEventBlock"})}set pollingInterval(e){S.throwError("cannot set polling interval on WebSocketProvider",E.errors.UNSUPPORTED_OPERATION,{operation:"setPollingInterval"})}poll(){return H(this,void 0,void 0,function*(){return null})}set polling(e){e&&S.throwError("cannot set polling on WebSocketProvider",E.errors.UNSUPPORTED_OPERATION,{operation:"setPolling"})}send(e,t){const s=re++;return new Promise((i,c)=>{function l(n,o){return n?c(n):i(o)}const r=JSON.stringify({method:e,params:t,id:s,jsonrpc:"2.0"});this.emit("debug",{action:"request",request:JSON.parse(r),provider:this}),this._requests[String(s)]={callback:l,payload:r},this._wsReady&&this.websocket.send(r)})}static defaultUrl(){return"ws://localhost:8546"}_subscribe(e,t,s){return H(this,void 0,void 0,function*(){let i=this._subIds[e];i==null&&(i=Promise.all(t).then(l=>this.send("eth_subscribe",l)),this._subIds[e]=i);const c=yield i;this._subs[c]={tag:e,processFunc:s}})}_startEvent(e){switch(e.type){case"block":this._subscribe("block",["newHeads"],t=>{const s=V.from(t.number).toNumber();this._emitted.block=s,this.emit("block",s)});break;case"pending":this._subscribe("pending",["newPendingTransactions"],t=>{this.emit("pending",t)});break;case"filter":this._subscribe(e.tag,["logs",this._getFilter(e.filter)],t=>{t.removed==null&&(t.removed=!1),this.emit(e.filter,this.formatter.filterLog(t))});break;case"tx":{const t=s=>{const i=s.hash;this.getTransactionReceipt(i).then(c=>{c&&this.emit(i,c)})};t(e),this._subscribe("tx",["newHeads"],s=>{this._events.filter(i=>i.type==="tx").forEach(t)});break}case"debug":case"poll":case"willPoll":case"didPoll":case"error":break;default:console.log("unhandled:",e);break}}_stopEvent(e){let t=e.tag;if(e.type==="tx"){if(this._events.filter(i=>i.type==="tx").length)return;t="tx"}else if(this.listenerCount(e.event))return;const s=this._subIds[t];s&&(delete this._subIds[t],s.then(i=>{this._subs[i]&&(delete this._subs[i],this.send("eth_unsubscribe",[i]))}))}destroy(){return H(this,void 0,void 0,function*(){this.websocket.readyState===T.CONNECTING&&(yield new Promise(e=>{this.websocket.onopen=function(){e(!0)},this.websocket.onerror=function(){e(!1)}})),this.websocket.close(1e3)})}}var B={},U;function ce(){if(U)return B;U=1,Object.defineProperty(B,"__esModule",{value:!0});var a="Provided shouldReconnect() returned false. Closing permanently.",e="Provided shouldReconnect() resolved to false. Closing permanently.",t=function(){function r(n,o,u){if(u===void 0&&(u={}),this.url=n,this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this.ondown=null,this.onreopen=null,this.CONNECTING=r.CONNECTING,this.OPEN=r.OPEN,this.CLOSING=r.CLOSING,this.CLOSED=r.CLOSED,this.hasBeenOpened=!1,this.isClosed=!1,this.messageBuffer=[],this.nextRetryTime=0,this.reconnectCount=0,this.lastKnownExtensions="",this.lastKnownProtocol="",this.listeners={},o==null||typeof o=="string"||Array.isArray(o)?this.protocols=o:u=o,this.options=s(u),!this.options.wsConstructor)if(typeof WebSocket<"u")this.options.wsConstructor=WebSocket;else throw new Error("WebSocket not present in global scope and no wsConstructor option was provided.");this.openNewWebSocket()}return Object.defineProperty(r.prototype,"binaryType",{get:function(){return this.binaryTypeInternal||"blob"},set:function(n){this.binaryTypeInternal=n,this.ws&&(this.ws.binaryType=n)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bufferedAmount",{get:function(){var n=this.ws?this.ws.bufferedAmount:0,o=!1;return this.messageBuffer.forEach(function(u){var h=i(u);h!=null?n+=h:o=!0}),o&&this.debugLog("Some buffered data had unknown length. bufferedAmount() return value may be below the correct amount."),n},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"extensions",{get:function(){return this.ws?this.ws.extensions:this.lastKnownExtensions},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"protocol",{get:function(){return this.ws?this.ws.protocol:this.lastKnownProtocol},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"readyState",{get:function(){return this.isClosed?r.CLOSED:r.OPEN},enumerable:!0,configurable:!0}),r.prototype.close=function(n,o){this.disposeSocket(n,o),this.shutdown(),this.debugLog("WebSocket permanently closed by client.")},r.prototype.send=function(n){if(this.isClosed)throw new Error("WebSocket is already in CLOSING or CLOSED state.");this.ws&&this.ws.readyState===this.OPEN?this.ws.send(n):this.messageBuffer.push(n)},r.prototype.reconnect=function(){if(this.isClosed)throw new Error("Cannot call reconnect() on socket which is permanently closed.");this.disposeSocket(1e3,"Client requested reconnect."),this.handleClose(void 0)},r.prototype.addEventListener=function(n,o){this.listeners[n]||(this.listeners[n]=[]),this.listeners[n].push(o)},r.prototype.dispatchEvent=function(n){return this.dispatchEventOfType(n.type,n)},r.prototype.removeEventListener=function(n,o){this.listeners[n]&&(this.listeners[n]=this.listeners[n].filter(function(u){return u!==o}))},r.prototype.openNewWebSocket=function(){var n=this;if(!this.isClosed){var o=this.options,u=o.connectTimeout,h=o.wsConstructor;this.debugLog("Opening new WebSocket to "+this.url+".");var f=new h(this.url,this.protocols);f.onclose=function(d){return n.handleClose(d)},f.onerror=function(d){return n.handleError(d)},f.onmessage=function(d){return n.handleMessage(d)},f.onopen=function(d){return n.handleOpen(d)},this.connectTimeoutId=setTimeout(function(){n.clearConnectTimeout(),n.disposeSocket(),n.handleClose(void 0)},u),this.ws=f}},r.prototype.handleOpen=function(n){var o=this;if(!(!this.ws||this.isClosed)){var u=this.options.allClearResetTime;this.debugLog("WebSocket opened."),this.binaryTypeInternal!=null?this.ws.binaryType=this.binaryTypeInternal:this.binaryTypeInternal=this.ws.binaryType,this.clearConnectTimeout(),this.hasBeenOpened?this.dispatchEventOfType("reopen",n):(this.dispatchEventOfType("open",n),this.hasBeenOpened=!0),this.messageBuffer.forEach(function(h){return o.send(h)}),this.messageBuffer=[],this.allClearTimeoutId=setTimeout(function(){o.clearAllClearTimeout(),o.nextRetryTime=0,o.reconnectCount=0;var h=u/1e3|0;o.debugLog("WebSocket remained open for "+h+" seconds. Resetting retry time and count.")},u)}},r.prototype.handleMessage=function(n){this.isClosed||this.dispatchEventOfType("message",n)},r.prototype.handleClose=function(n){var o=this;if(!this.isClosed){var u=this.options,h=u.maxReconnectAttempts,f=u.shouldReconnect;if(this.clearConnectTimeout(),this.clearAllClearTimeout(),this.ws&&(this.lastKnownExtensions=this.ws.extensions,this.lastKnownProtocol=this.ws.protocol,this.disposeSocket()),this.dispatchEventOfType("down",n),this.reconnectCount>=h){this.stopReconnecting(n,this.getTooManyFailedReconnectsMessage());return}var d=!n||f(n);typeof d=="boolean"?this.handleWillReconnect(d,n,a):d.then(function(g){o.isClosed||o.handleWillReconnect(g,n,e)})}},r.prototype.handleError=function(n){this.dispatchEventOfType("error",n),this.debugLog("WebSocket encountered an error.")},r.prototype.handleWillReconnect=function(n,o,u){n?this.reestablishConnection():this.stopReconnecting(o,u)},r.prototype.reestablishConnection=function(){var n=this,o=this.options,u=o.minReconnectDelay,h=o.maxReconnectDelay,f=o.reconnectBackoffFactor;this.reconnectCount++;var d=this.nextRetryTime;this.nextRetryTime=Math.max(u,Math.min(this.nextRetryTime*f,h)),setTimeout(function(){return n.openNewWebSocket()},d);var g=d/1e3|0;this.debugLog("WebSocket was closed. Re-opening in "+g+" seconds.")},r.prototype.stopReconnecting=function(n,o){this.debugLog(o),this.shutdown(),n&&this.dispatchEventOfType("close",n)},r.prototype.shutdown=function(){this.isClosed=!0,this.clearAllTimeouts(),this.messageBuffer=[],this.disposeSocket()},r.prototype.disposeSocket=function(n,o){this.ws&&(this.ws.onerror=l,this.ws.onclose=l,this.ws.onmessage=l,this.ws.onopen=l,this.ws.close(n,o),this.ws=void 0)},r.prototype.clearAllTimeouts=function(){this.clearConnectTimeout(),this.clearAllClearTimeout()},r.prototype.clearConnectTimeout=function(){this.connectTimeoutId!=null&&(clearTimeout(this.connectTimeoutId),this.connectTimeoutId=void 0)},r.prototype.clearAllClearTimeout=function(){this.allClearTimeoutId!=null&&(clearTimeout(this.allClearTimeoutId),this.allClearTimeoutId=void 0)},r.prototype.dispatchEventOfType=function(n,o){var u=this;switch(n){case"close":this.onclose&&this.onclose(o);break;case"error":this.onerror&&this.onerror(o);break;case"message":this.onmessage&&this.onmessage(o);break;case"open":this.onopen&&this.onopen(o);break;case"down":this.ondown&&this.ondown(o);break;case"reopen":this.onreopen&&this.onreopen(o);break}return n in this.listeners&&this.listeners[n].slice().forEach(function(h){return u.callListener(h,o)}),!o||!o.defaultPrevented},r.prototype.callListener=function(n,o){typeof n=="function"?n.call(this,o):n.handleEvent.call(this,o)},r.prototype.debugLog=function(n){this.options.debug&&console.log(n)},r.prototype.getTooManyFailedReconnectsMessage=function(){var n=this.options.maxReconnectAttempts;return"Failed to reconnect after "+n+" "+c("attempt",n)+". Closing permanently."},r.DEFAULT_OPTIONS={allClearResetTime:5e3,connectTimeout:5e3,debug:!1,minReconnectDelay:1e3,maxReconnectDelay:3e4,maxReconnectAttempts:Number.POSITIVE_INFINITY,reconnectBackoffFactor:1.5,shouldReconnect:function(){return!0},wsConstructor:void 0},r.CONNECTING=0,r.OPEN=1,r.CLOSING=2,r.CLOSED=3,r}();B.default=t;function s(r){var n={};return Object.keys(t.DEFAULT_OPTIONS).forEach(function(o){var u=r[o];n[o]=u===void 0?t.DEFAULT_OPTIONS[o]:u}),n}function i(r){return typeof r=="string"?2*r.length:r instanceof ArrayBuffer?r.byteLength:r instanceof Blob?r.size:void 0}function c(r,n){return n===1?r:r+"s"}function l(){}return B}var le=ce();const ae=z(le),ue=120;class he{constructor(e){this.provider=e,this.maxBackfillBlocks=ue}getNewHeadsBackfill(e,t,s){return b(this,void 0,void 0,function*(){m(e);const i=yield this.getBlockNumber();if(m(e),t.length===0)return this.getHeadEventsInRange(Math.max(s,i-this.maxBackfillBlocks)+1,i+1);const c=p(t[t.length-1].number),l=i-this.maxBackfillBlocks+1;if(c<=l)return this.getHeadEventsInRange(l,i+1);const r=yield this.getReorgHeads(e,t);m(e);const n=yield this.getHeadEventsInRange(c+1,i+1);return m(e),[...r,...n]})}getLogsBackfill(e,t,s,i){return b(this,void 0,void 0,function*(){m(e);const c=yield this.getBlockNumber();if(m(e),s.length===0)return this.getLogsInRange(t,Math.max(i,c-this.maxBackfillBlocks)+1,c+1);const l=p(s[s.length-1].blockNumber),r=c-this.maxBackfillBlocks+1;if(l<r)return this.getLogsInRange(t,r,c+1);const n=yield this.getCommonAncestor(e,s);m(e);const o=s.filter(f=>p(f.blockNumber)>n.blockNumber).map(f=>Object.assign(Object.assign({},f),{removed:!0})),u=n.blockNumber===Number.NEGATIVE_INFINITY?p(s[0].blockNumber):n.blockNumber;let h=yield this.getLogsInRange(t,u,c+1);return h=h.filter(f=>f&&(p(f.blockNumber)>n.blockNumber||p(f.logIndex)>n.logIndex)),m(e),[...o,...h]})}setMaxBackfillBlock(e){this.maxBackfillBlocks=e}getBlockNumber(){return b(this,void 0,void 0,function*(){const e=yield this.provider.send("eth_blockNumber");return p(e)})}getHeadEventsInRange(e,t){return b(this,void 0,void 0,function*(){if(e>=t)return[];const s=[];for(let c=e;c<t;c++)s.push({method:"eth_getBlockByNumber",params:[N(c),!1]});return(yield this.provider.sendBatch(s)).map(G)})}getReorgHeads(e,t){return b(this,void 0,void 0,function*(){const s=[];for(let i=t.length-1;i>=0;i--){const c=t[i],l=yield this.getBlockByNumber(p(c.number));if(m(e),c.hash===l.hash)break;s.push(G(l))}return s.reverse()})}getBlockByNumber(e){return b(this,void 0,void 0,function*(){return this.provider.send("eth_getBlockByNumber",[N(e),!1])})}getCommonAncestor(e,t){return b(this,void 0,void 0,function*(){let s=yield this.getBlockByNumber(p(t[t.length-1].blockNumber));m(e);for(let i=t.length-1;i>=0;i--){const c=t[i];if(c.blockNumber!==s.number&&(s=yield this.getBlockByNumber(p(c.blockNumber))),c.blockHash===s.hash)return{blockNumber:p(c.blockNumber),logIndex:p(c.logIndex)}}return{blockNumber:Number.NEGATIVE_INFINITY,logIndex:Number.NEGATIVE_INFINITY}})}getLogsInRange(e,t,s){return b(this,void 0,void 0,function*(){if(t>=s)return[];const i=Object.assign(Object.assign({},e),{fromBlock:N(t),toBlock:N(s-1)});return this.provider.send("eth_getLogs",[i])})}}function G(a){const e=Object.assign({},a);return delete e.totalDifficulty,delete e.transactions,delete e.uncles,e}function de(a){return $(a,e=>e.hash)}function fe(a){return $(a,e=>`${e.blockHash}/${e.logIndex}`)}function $(a,e){const t=new Set,s=[];return a.forEach(i=>{const c=e(i);t.has(c)||(t.add(c),s.push(i))}),s}const be=new Error("Cancelled");function m(a){if(a())throw be}const pe=3e4,me=1e4,K=6e4,Y=5,ge=10;class Pe extends oe{constructor(e,t){var s;const i=x.getApiKey(e.apiKey),c=x.getAlchemyNetwork(e.network),l=x.getAlchemyConnectionInfo(c,i,"wss"),r=`alchemy-sdk-${X}`,n=new ae((s=e.url)!==null&&s!==void 0?s:l.url,r,{wsConstructor:t??ye()}),o=Q[c];super(n,o??void 0),this._events=[],this.virtualSubscriptionsById=new Map,this.virtualIdsByPhysicalId=new Map,this.handleMessage=u=>{const h=JSON.parse(u.data);if(!Ne(h))return;const f=h.params.subscription,d=this.virtualIdsByPhysicalId.get(f);if(!d)return;const g=this.virtualSubscriptionsById.get(d);if(g.method==="eth_subscribe")switch(g.params[0]){case"newHeads":{const w=g,C=h,{isBackfilling:O,backfillBuffer:P}=w,{result:k}=C.params;O?Se(P,k):f!==d?this.emitAndRememberEvent(d,k,A):this.rememberEvent(d,k,A);break}case"logs":{const w=g,C=h,{isBackfilling:O,backfillBuffer:P}=w,{result:k}=C.params;O?Be(P,k):d!==f?this.emitAndRememberEvent(d,k,R):this.rememberEvent(d,k,R);break}default:if(f!==d){const{result:w}=h.params;this.emitEvent(d,w)}}},this.handleReopen=()=>{this.virtualIdsByPhysicalId.clear();const{cancel:u,isCancelled:h}=Ee();this.cancelBackfill=u;for(const f of this.virtualSubscriptionsById.values())b(this,void 0,void 0,function*(){try{yield this.resubscribeAndBackfill(h,f)}catch(d){h()||console.error(`Error while backfilling "${f.params[0]}" subscription. Some events may be missing.`,d)}});this.startHeartbeat()},this.stopHeartbeatAndBackfill=()=>{this.heartbeatIntervalId!=null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=void 0),this.cancelBackfill()},this.apiKey=i,this.backfiller=new he(this),this.addSocketListeners(),this.startHeartbeat(),this.cancelBackfill=Z}static getNetwork(e){return typeof e=="string"&&e in M?M[e]:ie(e)}on(e,t){return this._addEventListener(e,t,!1)}once(e,t){return this._addEventListener(e,t,!0)}off(e,t){return _(e)?this._off(e,t):super.off(e,t)}removeAllListeners(e){return e!==void 0&&_(e)?this._removeAllListeners(e):super.removeAllListeners(e)}listenerCount(e){return e!==void 0&&_(e)?this._listenerCount(e):super.listenerCount(e)}listeners(e){return e!==void 0&&_(e)?this._listeners(e):super.listeners(e)}_addEventListener(e,t,s){if(_(e)){ee(e);const i=new te(v(e),t,s);return this._events.push(i),this._startEvent(i),this}else return super._addEventListener(e,t,s)}_startEvent(e){[...L,"block","filter"].includes(e.type)?this.customStartEvent(e):super._startEvent(e)}_subscribe(e,t,s,i){return b(this,void 0,void 0,function*(){let c=this._subIds[e];const l=yield this.getBlockNumber();c==null&&(c=Promise.all(t).then(o=>this.send("eth_subscribe",o)),this._subIds[e]=c);const r=yield c,n=yield Promise.all(t);this.virtualSubscriptionsById.set(r,{event:i,method:"eth_subscribe",params:n,startingBlockNumber:l,virtualId:r,physicalId:r,sentEvents:[],isBackfilling:!1,backfillBuffer:[]}),this.virtualIdsByPhysicalId.set(r,r),this._subs[r]={tag:e,processFunc:s}})}emit(e,...t){if(_(e)){let s=!1;const i=[],c=v(e);return this._events=this._events.filter(l=>l.tag!==c?!0:(setTimeout(()=>{l.listener.apply(this,t)},0),s=!0,l.once?(i.push(l),!1):!0)),i.forEach(l=>{this._stopEvent(l)}),s}else return super.emit(e,...t)}sendBatch(e){return b(this,void 0,void 0,function*(){let t=0;const s=e.map(({method:i,params:c})=>({method:i,params:c,jsonrpc:"2.0",id:`alchemy-sdk:${t++}`}));return this.sendBatchConcurrently(s)})}destroy(){return this.removeSocketListeners(),this.stopHeartbeatAndBackfill(),super.destroy()}isCommunityResource(){return this.apiKey===se}_stopEvent(e){let t=e.tag;if(L.includes(e.type)){if(this._events.filter(i=>L.includes(i.type)).length)return}else if(e.type==="tx"){if(this._events.filter(i=>i.type==="tx").length)return;t="tx"}else if(this.listenerCount(e.event))return;const s=this._subIds[t];s&&(delete this._subIds[t],s.then(i=>{this._subs[i]&&(delete this._subs[i],this.send("eth_unsubscribe",[i]))}))}addSocketListeners(){this._websocket.addEventListener("message",this.handleMessage),this._websocket.addEventListener("reopen",this.handleReopen),this._websocket.addEventListener("down",this.stopHeartbeatAndBackfill)}removeSocketListeners(){this._websocket.removeEventListener("message",this.handleMessage),this._websocket.removeEventListener("reopen",this.handleReopen),this._websocket.removeEventListener("down",this.stopHeartbeatAndBackfill)}resubscribeAndBackfill(e,t){return b(this,void 0,void 0,function*(){const{virtualId:s,method:i,params:c,sentEvents:l,backfillBuffer:r,startingBlockNumber:n}=t;t.isBackfilling=!0,r.length=0;try{const o=yield this.send(i,c);switch(m(e),t.physicalId=o,this.virtualIdsByPhysicalId.set(o,s),c[0]){case"newHeads":{const u=yield q(()=>D(this.backfiller.getNewHeadsBackfill(e,l,n),K),Y,()=>!e());m(e),de([...u,...r]).forEach(f=>this.emitNewHeadsEvent(s,f));break}case"logs":{const u=c[1]||{},h=yield q(()=>D(this.backfiller.getLogsBackfill(e,u,l,n),K),Y,()=>!e());m(e),fe([...h,...r]).forEach(d=>this.emitLogsEvent(s,d));break}default:break}}finally{t.isBackfilling=!1,r.length=0}})}emitNewHeadsEvent(e,t){this.emitAndRememberEvent(e,t,A)}emitLogsEvent(e,t){this.emitAndRememberEvent(e,t,R)}emitAndRememberEvent(e,t,s){this.rememberEvent(e,t,s),this.emitEvent(e,t)}emitEvent(e,t){const s=this.virtualSubscriptionsById.get(e);s&&this.emitGenericEvent(s,t)}rememberEvent(e,t,s){const i=this.virtualSubscriptionsById.get(e);i&&F(i.sentEvents,Object.assign({},t),s)}emitGenericEvent(e,t){this.emitProcessFn(e.event)(t)}startHeartbeat(){this.heartbeatIntervalId==null&&(this.heartbeatIntervalId=setInterval(()=>b(this,void 0,void 0,function*(){try{yield D(this.send("net_version"),me)}catch{this._websocket.reconnect()}}),pe))}sendBatchConcurrently(e){return b(this,void 0,void 0,function*(){return Promise.all(e.map(t=>this.send(t.method,t.params)))})}customStartEvent(e){if(e.type===W){const{fromAddress:t,toAddress:s,hashesOnly:i}=e;this._subscribe(e.tag,[I.PENDING_TRANSACTIONS,{fromAddress:t,toAddress:s,hashesOnly:i}],this.emitProcessFn(e),e)}else if(e.type===j){const{addresses:t,includeRemoved:s,hashesOnly:i}=e;this._subscribe(e.tag,[I.MINED_TRANSACTIONS,{addresses:t,includeRemoved:s,hashesOnly:i}],this.emitProcessFn(e),e)}else e.type==="block"?this._subscribe("block",["newHeads"],this.emitProcessFn(e),e):e.type==="filter"&&this._subscribe(e.tag,["logs",this._getFilter(e.filter)],this.emitProcessFn(e),e)}emitProcessFn(e){switch(e.type){case W:return t=>this.emit({method:I.PENDING_TRANSACTIONS,fromAddress:e.fromAddress,toAddress:e.toAddress,hashesOnly:e.hashesOnly},t);case j:return t=>this.emit({method:I.MINED_TRANSACTIONS,addresses:e.addresses,includeRemoved:e.includeRemoved,hashesOnly:e.hashesOnly},t);case"block":return t=>{const s=V.from(t.number).toNumber();this._emitted.block=s,this.emit("block",s)};case"filter":return t=>{t.removed==null&&(t.removed=!1),this.emit(e.filter,this.formatter.filterLog(t))};default:throw new Error("Invalid event type to `emitProcessFn()`")}}_off(e,t){if(t==null)return this.removeAllListeners(e);const s=[];let i=!1;const c=v(e);return this._events=this._events.filter(l=>l.tag!==c||l.listener!=t||i?!0:(i=!0,s.push(l),!1)),s.forEach(l=>{this._stopEvent(l)}),this}_removeAllListeners(e){let t=[];if(e==null)t=this._events,this._events=[];else{const s=v(e);this._events=this._events.filter(i=>i.tag!==s?!0:(t.push(i),!1))}return t.forEach(s=>{this._stopEvent(s)}),this}_listenerCount(e){if(!e)return this._events.length;const t=v(e);return this._events.filter(s=>s.tag===t).length}_listeners(e){if(e==null)return this._events.map(s=>s.listener);const t=v(e);return this._events.filter(s=>s.tag===t).map(s=>s.listener)}}function ye(){return ke()?require("websocket").w3cwebsocket:WebSocket}function ke(){return typeof process<"u"&&process!=null&&process.versions!=null&&process.versions.node!=null}function Ee(){let a=!1;return{cancel:()=>a=!0,isCancelled:()=>a}}const _e=1e3,ve=2,we=3e4;function q(a,e,t=()=>!0){return b(this,void 0,void 0,function*(){let s=0,i=0;for(;;)try{return yield a()}catch(c){if(i++,i>=e||!t(c)||(yield Te(s),!t(c)))throw c;s=s===0?_e:Math.min(we,ve*s)}})}function Te(a){return new Promise(e=>setTimeout(e,a))}function D(a,e){return Promise.race([a,new Promise((t,s)=>setTimeout(()=>s(new Error("Timeout")),e))])}function A(a){return p(a.number)}function R(a){return p(a.blockNumber)}function Ie(a){return Array.isArray(a)||a.jsonrpc==="2.0"&&a.id!==void 0}function Ne(a){return!Ie(a)}function Se(a,e){F(a,e,A)}function Be(a,e){F(a,e,R)}function F(a,e,t){const s=t(e),i=a.findIndex(c=>t(c)>s-ge);i===-1?a.length=0:a.splice(0,i),a.push(e)}export{Pe as AlchemyWebSocketProvider};
